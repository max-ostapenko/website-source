---
title: Safe query costs with BigQuery
date: "6/20/2024"
categories:
    - google bigquery
description: Processing data in BigQuery offers immense power and scalability, but it can also lead to unexpected costs if not managed properly.
---

Processing data in BigQuery offers immense power and scalability, but it can also lead to unexpected costs if not managed properly.
This [recent story from the HTTP Archive community](https://discuss.httparchive.org/t/warning-14-000-bigquery-charge-in-2-hours/2715) and other cost issues are often shared publicly prove that *Attention* signs don't work.

## A Costly Human Error

Over the years, I've observed numerous instances where a single or looped queries result in abysmal charges of $1,000 or even $10,000+. A champion I've seen had a $163K increment to their bill. This isn't just a problem for BigQuery data analysts; engineers working with datasets can also face significant financial consequences due to code bugs. Extensive experience alone doesn't seem to protect from making a costly mistake.

I've also had unpleasant tasks leading investigation and implementing safety measures after substantial cost spikes. Despite being aware of storage and SQL optimizations, human error is inevitable.

This highlights the necessity of implementing cost safety measures regardless of experience level. Over the years, I've seen these few simple preventive steps save us from subsequent billing issues. Implementing these steps in advance can protect you from unexpected costs. And it's the only reliable way no matter what client and account are used to access BigQuery.

## Steps to Ensure Cost Safety in BigQuery

### 1. Set Query Usage Quotas
Prevent excessive query usage by limiting the amount of data that can be processed in a day. Whenever a subsequent query exceeds the quota, it will fail. You can adjust query usage quota values at the project or user level.

**Step-by-Step Guide**

1. In the Google Cloud Console go to [API & Services > BigQuery API > Quotas & System Limits](https://console.cloud.google.com/apis/api/bigquery.googleapis.com/quotas?pageState=(%22allQuotasTable%22:(%22f%22:%22%255B%257B_22k_22_3A_22Name_22_2C_22t_22_3A10_2C_22v_22_3A_22_5C_22query_5C_22_22_2C_22i_22_3A_22displayName_22%257D%255D%22))).
2. Select the quota you want to adjust.
3. Click "Edit Quotas" and enter your desired values.
4. Submit your changes.
5. Return to exploring petabytes of data with peace of mind.

Or open [Cloud Shell terminal](https://shell.cloud.google.com/?hl=en_US&fromcloudshell=true&show=terminal) and run a command to bring your quota down to 1TB per user per day:
```sh
gcloud alpha services quota update --consumer=projects/PROJECT_ID --service=bigquery.googleapis.com --metric=bigquery.googleapis.com/quota/query/usage --unit=1/d/{project}/{user} --value=1048576
```

![BigQuery API / Quotas](./images/query_quotas.png){fig-align="center" width=70% .preview-image}

By the way, you've probably seen the Maximum bytes billed parameter in query settings and wondered how *the project default* can be set - currently, only indirectly using these API quotas.

### 2. Set Up Budget Alerts
Stay aware of your spending trends and get notified before costs spiral out of control.

**Step-by-Step Guide**

1. In the Google Cloud Console go to [Billing](https://console.cloud.google.com/billing) and select your billing account
2. Go to Budgets & Alerts and click "Create Budget."
3. [Configure](https://cloud.google.com/billing/docs/how-to/budgets#create-budget) and save your budget.

Or open [Cloud Shell terminal](https://shell.cloud.google.com/?hl=en_US&fromcloudshell=true&show=terminal) and run a command to create a default budget for BigQuery:
```sh
gcloud config set project PROJECT_ID
gcloud billing budgets create --billing-account=BILLING_ACCOUNT --display-name="BigQuery Budget" --filter-services=services/24E6-581D-38E5 --last-period-amount --threshold-rule=percent=0.5,basis=forecasted-spend --threshold-rule=percent=0.9,basis=forecasted-spend --threshold-rule=percent=1,basis=forecasted-spend
```

## Don't wait till it's your time to worry about a *big bill*

No amount of experience safeguards against human error. Implementing usage quotas and budget alerts in BigQuery is essential to prevent costly mistakes. These steps provide a safety net, ensuring that both small and large-scale operations can manage their data processing costs effectively.

For small businesses these measures can help avoid unexpected costs during data processing spikes. By setting a quota, you ensure that no single query or user can bankrupt your budget.

Large enterprises can manage and monitor querying quotas and budgets at the department level. Monitoring spending helps them stay within allocated budgets and avoid financial investigations.

By following these steps, you can avoid the need to seek Google's forgiveness for an unexpected bill and maintain strict control over your data processing costs.
